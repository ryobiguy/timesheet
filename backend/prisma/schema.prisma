// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                 String   @id @default(cuid())
  name               String
  companyCode        String?  @unique // 6-digit unique code (nullable for migration)
  subscriptionTier   String   @default("free")
  stripeCustomerId   String?
  stripeSubscriptionId String?
  subscriptionStatus String?  // active | past_due | canceled | trialing | unpaid
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  users     User[]
  jobsites  Jobsite[]
  summaries TimesheetSummary[]

  @@map("organizations")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  passwordHash String
  role         String    @default("WORKER") // ADMIN | SUPERVISOR | WORKER
  orgId        String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  org          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignments  Assignment[]
  events       GeofenceEvent[]
  entries      TimeEntry[]
  summaries    TimesheetSummary[]
  raisedDisputes Dispute[] @relation("DisputeRaisedBy")

  @@map("users")
}

model Jobsite {
  id          String   @id @default(cuid())
  name        String
  address     String
  latitude    Float
  longitude   Float
  radiusMeters Int      @default(150)
  orgId       String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignments Assignment[]
  events      GeofenceEvent[]
  entries     TimeEntry[]

  @@map("jobsites")
}

model Assignment {
  id           String   @id @default(cuid())
  workerId     String
  jobsiteId    String
  scheduleDays String   @default("[]") // JSON string array
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  worker  User     @relation(fields: [workerId], references: [id], onDelete: Cascade)
  jobsite Jobsite  @relation(fields: [jobsiteId], references: [id], onDelete: Cascade)

  @@unique([workerId, jobsiteId])
  @@map("assignments")
}

model GeofenceEvent {
  id        String      @id @default(cuid())
  workerId  String
  jobsiteId String
  type      String      @default("ENTER") // ENTER | EXIT
  timestamp DateTime    @default(now())
  accuracy  Float?
  source    String      @default("device")
  createdAt DateTime    @default(now())

  worker  User    @relation(fields: [workerId], references: [id], onDelete: Cascade)
  jobsite Jobsite @relation(fields: [jobsiteId], references: [id], onDelete: Cascade)

  @@map("geofence_events")
}

model TimeEntry {
  id                String     @id @default(cuid())
  workerId          String
  jobsiteId         String
  startAt           DateTime
  endAt             DateTime?
  durationMinutes   Int?
  status            String     @default("PENDING") // PENDING | APPROVED | DISPUTED
  createdFromEvents String     @default("[]") // JSON string array
  modifiedBy        String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  worker   User     @relation(fields: [workerId], references: [id], onDelete: Cascade)
  jobsite  Jobsite  @relation(fields: [jobsiteId], references: [id], onDelete: Cascade)
  disputes Dispute[]

  @@map("time_entries")
}

model Dispute {
  id           String   @id @default(cuid())
  timeEntryId  String
  raisedBy     String
  reason       String
  resolution   String?
  resolvedBy   String?
  resolvedAt   DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  timeEntry TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  raisedByUser User @relation("DisputeRaisedBy", fields: [raisedBy], references: [id], onDelete: Cascade)

  @@map("disputes")
}

model TimesheetSummary {
  id            String   @id @default(cuid())
  workerId      String
  orgId         String
  weekStart     DateTime
  totalRegular  Int      @default(0)
  totalOvertime Int      @default(0)
  approvalState String   @default("PENDING") // PENDING | APPROVED | REJECTED
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  worker User         @relation(fields: [workerId], references: [id], onDelete: Cascade)
  org    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([workerId, weekStart])
  @@map("timesheet_summaries")
}